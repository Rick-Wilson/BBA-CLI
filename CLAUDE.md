# Claude Code Instructions for BBA-CLI

## Windows VM Access via SSH

The EPBot DLLs are Windows-only. To run BBA/EPBot commands, use SSH to connect to the Windows VM running under Parallels.

### SSH Runner

Use the ssh_runner.py from Practice-Bidding-Scenarios:

```python
import os
os.environ['WINDOWS_HOST'] = '10.211.55.5'
os.environ['WINDOWS_USER'] = 'Rick'

import sys
sys.path.insert(0, '/Users/rick/Development/GitHub/Practice-Bidding-Scenarios/build-scripts-mac')
from ssh_runner import run_windows_command, mac_to_windows_path

# Example: Run a Windows command
returncode, stdout, stderr = run_windows_command('dir G:\\BBA-CLI', check=False)
print(stdout)
```

The ssh_runner automatically maps the network drives before each command using `net use`.

### Drive Mappings

The Windows VM has shared folders mapped to local GitHub repositories:

| Windows Drive | Mac Path | UNC Path |
|--------------|----------|----------|
| `G:` | `/Users/rick/Development/GitHub` | `\\Mac\Home\Development\GitHub` |
| `P:` | `/Users/rick/Development/GitHub/Practice-Bidding-Scenarios` | `\\Mac\Home\Development\GitHub\Practice-Bidding-Scenarios` |
| `S:` | `~/Documents/BCScript/2024-11-13` | `\\Mac\Home\Documents\BCScript\2024-11-13` |

So BBA-CLI is at `G:\BBA-CLI` on Windows.

### Convention Files

Convention card files (.bbsa) are located at:
- Mac: `/Users/rick/Development/GitHub/Practice-Bidding-Scenarios/bbsa/`
- Windows: `P:\bbsa\`

The default convention for testing is `21GF-DEFAULT.bbsa`.

### Running EPBot Wrapper

The epbot-wrapper is a .NET application that wraps the EPBot DLL:

```bash
# Build the wrapper
run_windows_command(r'cd /d G:\BBA-CLI\epbot-wrapper && dotnet build -c Release -o G:\BBA-CLI\dist\epbot-wrapper')

# Run with JSON input
run_windows_command(r'cd /d G:\BBA-CLI\dist\epbot-wrapper && type input.json | epbot-wrapper.exe')
```

Or in interactive mode:
```cmd
epbot-wrapper.exe --interactive
```

### Integration Tests

Test files are in `G:\BBA-CLI\integration-tests\`:
- `1N.pbn` - 500 deals where South should open 1NT
- `batch-request.json` - JSON input for epbot-wrapper
- `batch-response.json` - JSON output from epbot-wrapper
- `1N-output.pbn` - Converted PBN output

Expected results are in `P:\bba\1N.pbn` (generated by BBA.exe GUI).

## BBA Server

The bba-server is an ASP.NET Core API that wraps EPBot to generate bridge auctions. It's called by BBOAlert browser extensions.

### Server URLs

| Environment | URL |
|-------------|-----|
| Local (Windows VM) | `http://10.211.55.5:5000` |
| Public (Cloudflare tunnel) | `https://bba.harmonicsystems.com` |

### Key Endpoints

- `GET /health` - Health check
- `POST /api/auction/generate` - Generate auction for a deal
- `GET /api/scenarios` - List available scenarios
- `POST /api/scenario/select` - Record scenario selection (analytics)

### Admin Dashboard

- `GET /admin/dashboard` - Stats, charts, request history (IP whitelist protected)
- `GET /admin/whoami` - Debug endpoint showing detected IP and access status

Admin access requires IP to be in whitelist: `Valerie_Perez`, `Travis_Scott`, `Tom_Martinez`

### Server Management

All commands require ssh_runner setup:

```python
import os, sys
os.environ['WINDOWS_HOST'] = '10.211.55.5'
os.environ['WINDOWS_USER'] = 'Rick'
sys.path.insert(0, '/Users/rick/Development/GitHub/Practice-Bidding-Scenarios/build-scripts-mac')
from ssh_runner import run_windows_command
```

**Stop server:**
```python
run_windows_command('taskkill /IM bba-server.exe /F', check=False)
```

**Build server:**
```python
run_windows_command(r'cd /d G:\BBA-CLI\bba-server && dotnet publish -c Release -o G:\BBA-CLI\dist\bba-server')
```

**Start server** (must use scheduled task - SSH can't start interactive processes):
```python
run_windows_command(r'schtasks /Create /TN "StartBBAServer" /TR "G:\BBA-CLI\dist\bba-server\bba-server.exe" /SC ONCE /ST 00:00 /F && schtasks /Run /TN "StartBBAServer"')
```

**Restart server** (stop, build, start):
```python
run_windows_command('taskkill /IM bba-server.exe /F', check=False)
run_windows_command(r'cd /d G:\BBA-CLI\bba-server && dotnet publish -c Release -o G:\BBA-CLI\dist\bba-server')
run_windows_command(r'schtasks /Create /TN "StartBBAServer" /TR "G:\BBA-CLI\dist\bba-server\bba-server.exe" /SC ONCE /ST 00:00 /F && schtasks /Run /TN "StartBBAServer"')
```

**Verify running:**
```bash
curl http://10.211.55.5:5000/health
```

### Configuration

Server config is in `bba-server/appsettings.json`:
- `Pbs:DlrPath` - Path to scenario DLR files (`P:\dlr`)
- `Pbs:BbsaPath` - Path to convention card files (`P:\bbsa`)
- `Pbs:DefaultNsCard` - Default NS convention (`21GF-DEFAULT`)
- `Pbs:DefaultEwCard` - Default EW convention (`21GF-GIB`)

### Logs

Logs are in `G:\BBA-CLI\dist\bba-server\logs\`:
- `bba-server-YYYY-MM-DD.log` - Application logs
- `audit-auction-YYYY-MM.csv` - Auction request audit log
- `audit-scenario-YYYY-MM.csv` - Scenario selection audit log
