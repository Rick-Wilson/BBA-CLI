name: Build BBA-CLI

on:
  push:
    branches: [main]
    tags:
      - 'v*'  # Trigger on version tags
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout BBA-CLI
        uses: actions/checkout@v4
        with:
          path: BBA-CLI

      - name: Checkout dealer3 (for Rust dependencies)
        uses: actions/checkout@v4
        with:
          repository: rick-wilson/dealer3
          path: dealer3

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build C# EPBot Wrapper
        run: |
          cd BBA-CLI/epbot-wrapper
          dotnet build -c Release

      - name: Copy EPBot64.dll to wrapper output
        run: |
          copy BBA-CLI\epbot-wrapper\EPBot-8734\EPBot64.dll BBA-CLI\epbot-wrapper\bin\Release\net48\

      - name: Build Rust CLI
        run: |
          cd BBA-CLI/cli
          cargo build --release

      - name: Upload EPBot Wrapper
        uses: actions/upload-artifact@v4
        with:
          name: epbot-wrapper
          path: |
            BBA-CLI/epbot-wrapper/bin/Release/net48/

      - name: Upload Rust CLI
        uses: actions/upload-artifact@v4
        with:
          name: bba-cli
          path: BBA-CLI/cli/target/release/bba-cli.exe

      - name: Upload EPBot DLLs
        uses: actions/upload-artifact@v4
        with:
          name: epbot-dlls
          path: |
            BBA-CLI/epbot-wrapper/EPBot-8734/EPBot64.dll

      - name: Create Release Zip
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          mkdir BBA-CLI-Release
          copy BBA-CLI\cli\target\release\bba-cli.exe BBA-CLI-Release\
          copy BBA-CLI\epbot-wrapper\bin\Release\net48\*.exe BBA-CLI-Release\
          copy BBA-CLI\epbot-wrapper\bin\Release\net48\*.dll BBA-CLI-Release\
          copy BBA-CLI\epbot-wrapper\bin\Release\net48\*.config BBA-CLI-Release\
          Compress-Archive -Path BBA-CLI-Release\* -DestinationPath BBA-CLI-${{ github.ref_name }}-windows-x64.zip

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: BBA-CLI-${{ github.ref_name }}-windows-x64.zip
          generate_release_notes: true
